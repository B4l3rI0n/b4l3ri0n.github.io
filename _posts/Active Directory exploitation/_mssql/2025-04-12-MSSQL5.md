---
title: 6. Defensive Considerations
description: MSSQL server Defensive Considerations for IT and blue team
date: 2025-04-12 02:47:38 +/-0005
categories: [Active Directory, MSSQL]
tags: [Active Directory, MSSQL, Mitigation Techniques, Defensive Considerations , HTB Academy]
---

<style>
  details {
    margin: 20px 0;
  }

  summary {
    font-weight: bold;
    cursor: pointer;
  }

  summary:hover {
    color: #007BFF;
  }

  ul {
    margin-left: 20px;
  }
</style>
---
* TOC
{:toc}

---

### ðŸ›¡ï¸ Defensive Considerations

MSSQL Server offers a large number of security capabilities which may be fine-tuned to better protect an organization's data, as well as to comply with any necessary regulations. Although we won't cover everything in this section, we will discuss the most important ones.

---

### **Authentication and Authorization**

Properly configured authentication and authorization settings are crucial to securing a MSSQL Server. In Microsoft's documentation (*SQL Server Security Best Practices*) they make the following recommendations:

- **Windows Authentication** is preferred over SQL Server Authentication:
    - Uses the Kerberos security protocol
    - Supports additional password policies
    - Simplifies user management
- **Principle of Least Privilege**:
    - Users should be granted the **minimum permissions** required to carry out their tasks.
- **Strong and complex passwords** should be enforced for all logins:
    - For SQL Server Authentication: enforced by the server itself
    - For Windows Authentication: enforced by the domain

Besides Microsoftâ€™s suggestions, defenders may also:

- Avoid assigning **additional privileges to the `public` server role**, which is assigned by default to every login.
- Revoke the **guest database userâ€™s CONNECT** permission if it isn't required ([Microsoft](https://learn.microsoft.com/) [Documentation](https://learn.microsoft.com/en-us/sql/relational-databases/policy-based-management/guest-permissions-on-user-databases?view=sql-server-ver16)).
- **Disable and remove [orphaned](https://learn.microsoft.com/en-us/sql/sql-server/failover-clusters/troubleshoot-orphaned-users-sql-server?view=sql-server-ver16) users** (users without associated logins).
- **Revoke `sysadmin` access** for the `BUILTIN\Administrators` group:
    - This is assigned by default during installation.
    - Note: Attackers may still escalate from a local admin to `sysadmin` (see [NetSPI blog post](https://www.netspi.com/blog/technical-blog/network-pentesting/get-sql-server-sysadmin-privileges-local-admin-powerupsql/)).

**Server and database-level roles** should also be carefully considered:

- `serveradmin` should be treated **equivalent to `sysadmin`** since escalation is trivial.
- `db_securityadmin` should be treated **equivalent to `db_owner`** for the same reason.
- `db_owner` can:
    - Drop the database
    - Escalate to `sysadmin` if assigned to a **TRUSTWORTHY** database.

---

### **Surface Area Configuration**

MSSQL Server has many configuration settings, most of which are disabled by default. It is recommended to **keep unused features disabled** to reduce the attack surface.

Example to check whatâ€™s enabled on SQL01:

```sql
EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;
EXEC sp_configure;
EXEC sp_configure 'show advanced options', 0;
RECONFIGURE;
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/7dc416bb-c994-44d6-9547-ed0ccceeb798/image.png?table=block&id=1d385370-06ca-8044-b873-c8cfd12ef112&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=JisSC2Bn27WDT-lx25BQhS8yRgpIBRjhvI-7Dna6xpc&downloadName=image.png)

**Only essential settings should be enabled. Pay attention to:**

- `xp_cmdshell`: used to execute code
- `Ole Automation Procedures`: interact with COM objects and execute code
- `clr enabled`: run user assemblies

Note: `show advanced options` itself is a config setting and should remain **disabled unless needed**.

---

### **Extended Stored Procedures**

MSSQL provides a large number of extended stored procedures. Some of them (e.g., `xp_dirtree`, `xp_fileexist`, `xp_subdirs`) may be abused to **capture NetNTLMv2 hashes**.

> âš ï¸ If not strictly needed, access should be revoked.
> 

These procedures **cannot be disabled** but their **EXECUTE permissions can be revoked**:

```sql
REVOKE EXECUTE ON xp_dirtree TO public;
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/48237966-c1bb-4a89-b339-08d305449caa/image.png?table=block&id=1d385370-06ca-8088-bbc3-e55721e5ed5b&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=AvZmN61jk-BK6TsDMVNAee_9-rPNamFCGKabC6Bfv20&downloadName=image.png)

Result: general users (e.g., `ws_user`) will no longer be able to execute them.

> ðŸ“ These procedures are undocumented and used internally by the server.
Always test in staging environments before revoking access in production.
> 
> 
> If necessary, grant EXECUTE to **specific logins**.
> 

---

### **Updates and Patches**

As with any software, MSSQL Server receives **security patches** and **feature updates**. Microsoft terminology:

- **Cumulative Update**: Roll-up of all previous hotfixes.
- **Service Pack**: Tested, cumulative set of all fixes and updates.

> ðŸ› ï¸ Always keep MSSQL instances up-to-date.
But first, test updates in a staging environment to avoid breaking production.
> 

---

## **General Considerations**

Even with a hardened MSSQL Server, a weak environment undermines all efforts. Here are additional important areas:

---

### **Server Security**

The security of the server **running MSSQL** is as critical as the database itself.

- Keep the **OS up to date** to prevent exploits.
- Apply the **Principle of Least Privilege** to server access.
- **Restrict file access** to MSSQL Serverâ€™s files.
- Run MSSQL Server with the **appropriate service account**.

---

### **Application Security**

Applications often serve as a gateway to MSSQL via **SQL injection vulnerabilities**.

- Review all applications that interact with MSSQL for **SQL injection**.
- Host applications and databases on **separate servers**:
    - Prevent attackers from accessing the DB directly if RCE occurs on the app server.

---

### **Firewall Configuration**

Use **network segmentation** and **restrict access** to MSSQL ports.

- Default MSSQL TCP port is **1433**.
- **Block public access** to MSSQL unless absolutely necessary.

---

### **Regular Security Audits**

Even with best practices, **human error** happens. Conduct **regular security audits**, ideally by professionals.

- At a minimum, run:
    
    ```powershell
    Invoke-SQLAudit
    ```
    
    from **PowerUpSQL** to check for common misconfigurations.
    

---

Let me know if you'd like this exported as PDF, Markdown, or DOCX format!